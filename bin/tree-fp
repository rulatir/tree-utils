#!/usr/bin/env php
<?php
for($d=__DIR__;$d!=="/";$d=dirname($d)) if (is_file($f="$d/vendor/autoload.php")) { $g = require $f; break; }
if (!$g) { echo "Failed to load the autoloader. Complain to Composer authors for making it difficult."; exit(1); }

use Rulatir\Tree\Fingerprint;
use Rulatir\Tree\GlobFilter;

function parse_cmd(array $argv) : array
{
    array_shift($argv);
    if ("--debug"===$argv[0]) {
        array_shift($argv);
        $debugFile = array_shift($argv);
    }
    $repositoryRoot = array_shift($argv);
    $statefile = array_shift($argv);
    $paths = parse_paths($argv);
    return [$repositoryRoot, $statefile, $paths, $debugFile ?? null];
}

function parse_paths(array $argv) : array
{
    $result = [];
    while(count($argv)) {

        $path = trim(array_shift($argv));
        $result[] = '-n' === $path ? [array_shift($argv),true] : [$path,false];
    }
    return array_reverse($result);
}

function tree_fp(string $repositoryRoot, $stateFile, array $rules, ?string $debugFile)
{
    $filter = new GlobFilter();
    foreach($rules as $rule) {
        $filter->addRule(...$rule);
    }
    $fingerprint = new Fingerprint($repositoryRoot, $stateFile, $filter);
    echo md5($fingerprintJSON = json_encode($fingerprint->getFingerprint(),JSON_PRETTY_PRINT));
    if ($debugFile) file_put_contents($debugFile, $fingerprintJSON);
}

tree_fp(...parse_cmd($argv));
